# C2EO <img src="https://www.yegor256.com/images/books/elegant-objects/cactus.svg" height="32px" />

This is a translator of C/C++ to [EOLANG](https://www.eolang.org).
Semantic-preserving translation of C programs to EOLANG programs.

The 1st step is C to [EOLANG](https://www.eolang.org) S2S compiler.

*Прочитать на другом языке: [English](readme.md)*

&nbsp;
### Useful links:

* #### [Document with C2EO transform examples](./doc/transformExamples.md)

* #### [Project for playing with examples](./collection/eo-sources/main)

* #### [Tests](./project/tests/scripts)
&nbsp;
# Getting started guide


Should work. If it doesn't, [submit an issue](https://github.com/polystat/c2eo/issues),
we will fix it.

## Step 1. OS and tools
You need a [Linux](https://www.linux.org/pages/download/) operating system (we recommend to use [Ubuntu 20.+ ver.](https://ubuntu.com/download))

Tools:

1. [wget](https://www.tecmint.com/install-wget-in-linux/)
2. [tar](https://www.tecmint.com/install-tar-in-centos-rhel-and-fedora/)
3. [git](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git)
4. [cmake](https://cmake.org/download/)
5. [gcc](http://mirror.linux-ia64.org/gnu/gcc/releases/)
6. [g++](https://pkgs.org/download/g++)
7. [ninja-build](https://ninja-build.org/)
8. [python3.+](https://www.python.org/downloads/)

```bash
# Installation tools for Ubuntu

$ sudo apt install wget
$ sudo apt install tar
$ sudo apt install git
$ sudo apt install cmake
$ sudo apt install gcc
$ sudo apt install g++
$ sudo apt install ninja-build
$ sudo apt install python3
```

&nbsp;
## Step 2. Install LLVM + CLANG
```bash
$ wget https://github.com/llvm/llvm-project/archive/refs/tags/llvmorg-12.0.1.tar.gz
$ tar -xvf llvmorg-12.0.1.tar.gz
```
> [github](https://github.com/llvm/llvm-project) page of the LLVM project

&nbsp;
## Step 3. Build LLVM + CLANG
```bash
$ cmake --no-warn-unused-cli -DBUILD_SHARED_LIBS:STRING=ON -DLLVM_TARGETS_TO_BUILD:STRING=X86 -DCMAKE_EXPORT_COMPILE_COMMANDS:BOOL=TRUE "-DLLVM_ENABLE_PROJECTS:STRING=clang;compiler-rt" -DCMAKE_BUILD_TYPE:STRING=Debug -DLLVM_OPTIMIZED_TABLEGEN:STRING=ON -DLLVM_USE_SPLIT_DWARF:STRING=ON -DLLVM_USE_LINKER:STRING=gold ../llvm -G Ninja
```
```bash
$ cmake --build . --config Debug --target all -j 10 -- -j1 -l 2
```
```bash
$ mv ./llvm-project-llvmorg-12.0.1 ./llvm-clang
$ cd llvm-clang
$ mkdir build && cd $_
```

&nbsp;
## Step 4. Install C2EO
```bash
$ cd ../..
$ git clone https://github.com/kreofil/C2EO-draft.git c2eo
```
&nbsp;
## Step 5. Configuration C2EO

Конфигурация транспилятора c2eo связано с его компиляцией из исходных текстов. При расположении llvm и clang  в `~/llvm-clang` используемые в каталогах `project` и `project/src/transpiler` файлы `CMakeLists.txt` остаются неизменными.
Поэтому для выполнения компиляции нужно войти в `project/build` и выполнить в нем команду `cmake ..`
После этого в том же каталоге запустить сбрку проекта командой `make` или `cmake --build .`

&nbsp;
## Step 6. Run transpilation
> Use `--` at the end of command below to skip all errors:
```bash
$ cd ./project/bin
$ ./c2eo python3 launcher.py <file-of-c-program>
```

<details>
    <summary>More information here...</summary>

&nbsp;
## Executable transpiler file and scripts for building the program on EO

---
## Directory Hierarchy

These files are located in the `project / bin` directory

&nbsp;
## Run scripts

### Launching the program builder on EO

`python3 launcher.py <file-of-c-program>`

The `c2eo` transpiler is launched, then the` collector.py` script is launched. As a result of processing the source file in the C language, the file `global.eo` on EO is generated, which is transferred to the directory` result / eo / c2eo / src / `of the project on EO.

&nbsp;
## Support scripts and programs
---
### Transpilation and formation of intermediate files

`c2eo <file-of-c-program> <name>`

Executable native code launched from the launcher. Carries out transpilation of a C program with the formation of intermediate files containing separately external (global) and static artifacts with the extensions `* .glob` and` * .stat`, respectively. The files are created in the `project / assembly` directory. The transmitted name is generated by the launcher and sets the names for intermediate files. It can also run autonomously.

### Generating the global.eo file

`collector`

Based on intermediate files located in the `project / assembly` directory, it also creates a program file on EO` global.eo`. Launched from the launcher.

---
</details>


&nbsp;
## Step 7. Run eo generated files

Now the generated files in this [dir](result/eo/c2eo/src/)

[There](https://github.com/cqfn/eo) github page of EO project when you can learn about EO language

This [quick start](https://github.com/cqfn/eo#quick-start) for running your first eo project

&nbsp;
## Additional step. Project testing
* ### [Tests 1](./project/tests/scripts)
* ### [Tests 2](./project/tests/datasets/launcher-set/)

&nbsp;

&nbsp;

## Project structure

    .
    ├── collection
    │   ├── c-sources
    │   └── eo-sources
    ├── doc 
    ├── llvm-clang 
    ├── project 
    │   ├── assembly
    │   ├── bin
    │   ├── build
    │   ├── lib
    │   ├── src
    │   │   ├── transpiler
    │   │   ├── collector
    │   │   └── launcher
    │   ├── tests
    │   └── CMakeLists.txt
    ├── result
    │   ├── pom.xml
    │   ├── README.md
    │   ├── run.sh
    │   └── eo
    │       └── c2eo
    │           ├── run.sh
    │           └── eo  
    └── tmp 

* ### collection
  Каталог `collection` содержит исходные тексты программ на языках программирования C и EO, которые предполагается использовать как для интеграционного тестирования транспилятора, так и для проверки возможных вариантов трансформации в EO. Программы на C размещаются в подкаталоге `c-sources`. Они формируют наборы данных, позволяющие оценить работоспособность разрабатываемого транспилятора. В подкаталоге `eo-sources` размещаются программы на EO, которые используются для анализа различных вариантов кодогенерации, а также для анализа возможности трансформации программ с C в EO.

* ### doc
  Каталог `doc` содержит документацию, формируемую в ходе работы над проектом.


* ### llvm-clang
  Каталог `llvm-clang` предназначен для хранения сборки проекта llvm. Предполагается, что данная сборка будет формироваться на уровне бинарных кодов под конкретную автономную реализацию (докер, ВМ) и впоследствии не будет меняться. Вряд ли в ходе разработки проекта стоит переходить на более свежую версию llvm без особых на то оснований. Нахождение внутри проекта позволит ее распространять вместе с результатом работы. При этом можно посмотреть и выкинуть все лишнее, что не нужно для проекта, тем самым сократив 8 гигабайт до более приемлемого значения.

* ### project
  Каталог `project` содержит все то, что является результатом разработки. В данный момент в нем просматриваются следующие каталоги:

  * #### assembly
    Каталог, предназначенный для хранения промежуточных результатов, а также окончательного результата работы транспилятора. Из отдельных промежуточных файлов в нем формируется окончательный файл `global.eo`, который затем копируется (пересылается) в соответствующий подкаталог каталога `result`.

  * #### bin
    Каталог, в котором группируются все исполняемые файлы и скрипты, обеспечивающие работу транспилятора.

  * #### build
    Каталог предназначенный для сборки проекта. Предполагается сборка проекта с использованием `cmake`.В связи с этим используется иерархическая организация файлов в каждом из подпроектов, обеспечивающих выполнение отдельных функций, при необходимости должен размещаться свой  файл `CMakeLists.txt`. Также корневой файл `CMakeLists.txt` располагается в каталоге `project`.

  * #### lib
    Каталог, предназначеный для хранения статических и (или) динамических библиотек, формируемых в процессе создания проекта, если таковые появятся.

  * #### src
    Каталог `src` является ключевым для разработки. На данном этапе просматриваются два основных проекта, размещенные в соответствующих каталогах. В целом его содержание скорее всего будет меняться.

    * ##### transpiler
      Транспилятор, осуществляющий разбор AST одной единицы компиляции и формирующий на выходе объекты EO.Эти объекты размещаются в каталоге assembly и разделяются по двум файлам. В одном собираются все объекты, соответствующие глобальным артефактам, а в другом статическим. Учитывая специфику анализа AST, данный проект реализуется на C++.

    * ##### collector
      Каталог, в котором разрабатывается сборщик файла `global.eo`.В общем случае после обработки транспилятором всех единиц компиляции он осуществляет компоновку из множества файлов, содержащих как статические, так и глобальные объекты, единый файл объектов на EO. Разработка данной программы может вестись на языке сценариев.

    * ##### launcher
      Каталог, содержащий программу, котора осуществляет многократный запуск транспилятора по числу единиц компиляции, после чего передает управление сборщику полученных отдельных файлов в монолит. После завершения сборки данная программа  осуществляет перенос сформированного файла `global.eo` в каталог `result/eo/c2eo/src`.

  * #### [tests](./project/tests/scripts)
    Каталог с различными тестовыми программами и данными, проверяющими работоспособность разрабатываемого кода.

* ### result
  Каталог для хранения данных, используемых компилятором EO. В нем содержится информация о проекте на EO, обновляемая каждый раз при обновлении проекта этого компилятора

  * #### README.md
    Описание компилируемого проекта, которое формируется разработчиками c2eo и практически не меняется (может только корректироваться);

  * #### run.sh
    Cкрипт, осуществляющий запуск откомпилированного приложения;

  * #### eo
    Каталог, содержащий используемые библиотеки, написанные на EO для поддержки артефактов языка C, а также исходные тексты на EO, порождаемые транспилятором или сформированные вручную. Внутри каталога `eo` структура сформирована подкаталогов. Непосредственно в `eo` находится каталог `c2eo`, определяющий общее название пакета. В нем располагаются:

    * ##### app.eo
      Отвечает за запуск приложения (он пишется вручную и не изменяется);

    * ##### ctypes
      Каталог, который по сути определяет некоторую библиотеку объектов, написанную на EO и предназначенную для моделирования различных артефактов языка C;

    * ##### src
      Каталог, в который записывается файл `global.eo` с объектами, порожденными транспилятором в ходе анализа программы на C (он содержит объект `global`, в котором собраны все артефакты в виде соответствующих объектов).

Формирование файла `global.eo` по сути является основной задачей транспилятора и обеспечивает путем сборки множества единиц компиляции исходной программы на языке C.

&nbsp;
## Размещение программы на EO, полученной в ходе транспиляции
Представленная структура стала возможной из-за использования начальной инициализации объектов, имитирующих переменные языка C.

Транспиляция осуществляется отдельно для каждой единицы компиляции, которая на выходе формирует два файла:

* файл с описанием всех глобальных объектов, к которым относятся абстрактные объекты, полученные при трансформации абстрактных типов данных, глобальных переменных, глобальных описаний функций;

* файл с описанием всех статических объектов, которые трансформируются из описаний статических переменных и функций, расположенных в глобальном пространстве, статических переменных, размещенных внутри функций.

Эти два файла являются базовой заготовкой для дальнейшей сборки после транспиляции всех единиц компиляции проекта. Сама сборка на текущий момент заключается в формировании общего файла на языке программирования EO. В нем формируется глобаальный объект `global`, который содержит все объекты, полученные в результате компиляции абстрактных типов данных, внешних переменных, внешних функций, а также объектов, которые получены из файлов, описывающих статические объекты.

Количество статических объектов определяется количеством файлов со статическими артефактами. Размещение в едином объекте `global` всех данных позволяет без проблем обеспечить доступ как со стороны глобальных объектов к своим статическим данным, так и со стороных статических объектов к глобальным данным. Сборщик этого файла может в принципе быть отдельной программой, реализованной на любом удобном языке программирования.

При наличии в одной из единиц компиляции функции `main`, она преобразуется в соответствующий объект глобального пространства. А сразу за его описанием следует описание ее запуска. Функция может располагаться в любом месте глобального объекта.

В целом порядок сборки файла с глобальными объектами и статическими объектами несущественен.

Представленная схема обеспечивает полную автономность формирование программы на EO. Объект, запускающий приложение содержит только датаизацию глобального объекта. Он не меняется, оставаясь постоянным независимо от транспилируемого проекта.






